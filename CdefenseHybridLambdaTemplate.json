{
	"AWSTemplateFormatVersion": "2010-09-09",
	"Description": "CloudDefense Hybrid Lambda Template",
	"Parameters": {
		"Data": {
			"Type": "CommaDelimitedList",
			"Description": "Contains CloudDefense Account ID and Unique Key for establishing trust relationship"
		}
	},
	"Resources": {
		"EventBridgeIAMRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": [
									"events.amazonaws.com"
								]
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"RoleName": {
					"Fn::Join": [
						"-",
						[
							"Cdefense",
							{
								"Ref": "AWS::Region"
							},
							{
								"Fn::Select": [
									1,
									{
										"Ref": "Data"
									}
								]
							},
							"role_event_bridge"
						]
					]
				},
				"Policies": [
					{
						"PolicyName": "AllowPushEventsToCloudDefense",
						"PolicyDocument": {
							"Statement": [
								{
									"Effect": "Allow",
									"Action": [
										"events:PutEvents"
									],
									"Resource": [
										{
											"Fn::Join": [
												"",
												[
													"arn:aws:events:*:",
													{
														"Fn::Select": [
															1,
															{
																"Ref": "Data"
															}
														]
													},
													":event-bus/default"
												]
											]
										}
									]
								}
							]
						}
					}
				],
				"Tags": [
					{
						"Key": "Owner",
						"Value": "CloudDefense"
					}
				]
			}
		},
		"CloudDefenseIAMRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"AWS": {
									"Fn::Join": [
										"",
										[
											"arn:aws:iam::",
											{
												"Fn::Select": [
													1,
													{
														"Ref": "Data"
													}
												]
											},
											":root"
										]
									]
								}
							},
							"Condition": {
								"StringEquals": {
									"sts:ExternalId": {
										"Fn::Select": [
											0,
											{
												"Ref": "Data"
											}
										]
									}
								}
							},
							"Action": [
								"sts:AssumeRole"
							]
						}
					]
				},
				"Path": "/",
				"MaxSessionDuration": 43200,
				"RoleName": {
					"Fn::Join": [
						"-",
						[
							{
								"Fn::Select": [
									0,
									{
										"Ref": "Data"
									}
								]
							},
							"cdefense-hybrid-role"
						]
					]
				},
				"Policies": [
					{
						"PolicyName": "LambdaInvokePolicy",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Effect": "Allow",
									"Action": [
										"lambda:InvokeFunction",
										"lambda:InvokeFunctionUrl"
									],
									"Resource": {
										"Fn::GetAtt": [
											"HybridLambdaFunction",
											"Arn"
										]
									}
								}
							]
						}
					}
				],
				"Tags": [
					{
						"Key": "Owner",
						"Value": "CloudDefense"
					}
				]
			}
		},
                "CdefenseMotherShipCallback": {
			"Type": "Custom::CdefenseMotherShipCallback",
			"Version": "1.0",
			"DependsOn": [
				"CloudDefenseIAMRole",
				"HybridLambdaFunction"
			],
                    "Properties": {
				"ServiceToken": "serviceToken",
                        "XTenantId": "<x_tenant_id>",
                        "SourceControl": "<source_control>",
				"RoleArn": {
					"Fn::GetAtt": "CloudDefenseIAMRole.Arn"
				},
				"AccountId": {
					"Ref": "AWS::AccountId"
				},
				"ExternalId": {
					"Fn::Select": [
						0,
						{
							"Ref": "Data"
						}
					]
				},
				"LambdaFunctionUrl": {
					"Fn::GetAtt": [
						"HybridLambdaFunctionUrl",
						"FunctionUrl"
					]
				},
				"Tags": [
					{
						"Key": "Owner",
						"Value": "CloudDefense"
					}
				]
			}
		},
		"HybridLambdaExecutionRole": {
			"Type": "AWS::IAM::Role",
			"Properties": {
				"AssumeRolePolicyDocument": {
					"Version": "2012-10-17",
					"Statement": [
						{
							"Effect": "Allow",
							"Principal": {
								"Service": "lambda.amazonaws.com"
							},
							"Action": "sts:AssumeRole"
						}
					]
				},
				"ManagedPolicyArns": [
					"arn:aws:iam::aws:policy/service-role/AWSLambdaVPCAccessExecutionRole"
				],
				"Policies": [
					{
						"PolicyName": "HybridLambdaPolicy",
						"PolicyDocument": {
							"Version": "2012-10-17",
							"Statement": [
								{
									"Action": [
										"eks:DescribeCluster",
										"sts:GetCallerIdentity"
									],
									"Resource": {
										"Fn::Join": [
											"",
											[
												"arn:aws:eks:",
												{
													"Ref": "AWS::Region"
												},
												":",
												{
													"Ref": "AWS::AccountId"
												},
												":cluster/cdefense-hybrid"
											]
										]
									},
									"Effect": "Allow"
								}
							]
						}
					}
				]
			}
		},
		"HybridLambdaFunction": {
			"Type": "AWS::Lambda::Function",
			"DependsOn": [
				"HybridLambdaExecutionRole"
			],
			"Properties": {
				"FunctionName": "HybridLambdaFunction",
				"Runtime": "python3.9",
				"Handler": "lambda_function.lambda_handler",
                "Code": {
                  "S3Bucket": {
                    "Fn::Sub": "cdefense-hybrid-lambda-bucket-${AWS::Region}"
                  },
                  "S3Key": "<source_control>_lambda_function.zip"
                },
				"Role": {
					"Fn::GetAtt": [
						"HybridLambdaExecutionRole",
						"Arn"
					]
				},
				"Timeout": 30,
				"Environment": {
					"Variables": {
						"<source_control>_TOKEN": "<replace_this_with_token>",
						"<source_control>_USERNAME": "<git_username>",
						"IS_ENTERPRISE": "<is_enterprise>",
						"<source_control>_ENTERPRISE_URL": "<git_enterprise_url>"
					}
				}
			}
		},
		"HybridLambdaFunctionUrl": {
			"Type": "AWS::Lambda::Url",
			"DependsOn": [
				"HybridLambdaFunction"
			],
			"Properties": {
				"TargetFunctionArn": {
					"Fn::GetAtt": [
						"HybridLambdaFunction",
						"Arn"
					]
				},
				"AuthType": "AWS_IAM",
				"Cors": {
					"AllowOrigins": [
						"https://qa.clouddefenseai.com",
						"https://console.clouddefenseai.com"
					],
					"AllowMethods": [
						"GET",
						"POST"
					]
				}
			}
		}
	},
	"Outputs": {
		"StatusMessage": {
			"Value": {
				"Fn::GetAtt": "CloudDefenseIAMRole.Arn"
			},
			"Description": "Your account got connected successfully!"
		}
	}
}
